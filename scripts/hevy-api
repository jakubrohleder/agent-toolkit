#!/bin/bash
# Universal Hevy API wrapper
# Usage: hevy-api <METHOD> <endpoint> [json_file]
# JSON files: write to ./.tmp-hevy/, clean up after use

HEVY_API_KEY=$(cat ~/.hevy/.api_key 2>/dev/null)
if [ -z "$HEVY_API_KEY" ]; then
  echo '{"error": "API key not found. Add key to ~/.hevy/.api_key"}'
  exit 1
fi

METHOD="${1:-GET}"
ENDPOINT="$2"
JSON_FILE="$3"

if [ -z "$ENDPOINT" ]; then
  echo '{"error": "Usage: hevy-api <METHOD> <endpoint> [json_file]"}'
  exit 1
fi

URL="https://api.hevyapp.com${ENDPOINT}"

if [ -n "$JSON_FILE" ]; then
  if [ ! -f "$JSON_FILE" ]; then
    echo "{\"error\": \"JSON file not found: $JSON_FILE\"}"
    exit 1
  fi
  RESPONSE=$(curl -s -w "\n%{http_code}" -X "$METHOD" -H "api-key: $HEVY_API_KEY" -H "Content-Type: application/json" -d @"$JSON_FILE" "$URL")
else
  RESPONSE=$(curl -s -w "\n%{http_code}" -X "$METHOD" -H "api-key: $HEVY_API_KEY" "$URL")
fi

# Split response body and status code
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

# Check for HTTP errors
if [ "$HTTP_CODE" -ge 400 ]; then
  # If body is HTML (Bad Request), wrap in JSON
  if echo "$BODY" | grep -q "^<!DOCTYPE\|^<html"; then
    echo "{\"error\": \"HTTP $HTTP_CODE - Bad Request (check for @ symbol in notes)\"}"
  else
    # Return API error as-is
    echo "$BODY" | jq . 2>/dev/null || echo "{\"error\": \"HTTP $HTTP_CODE\", \"body\": \"$BODY\"}"
  fi
  exit 1
fi

# Success - format JSON
echo "$BODY" | jq . 2>/dev/null || echo "$BODY"
